# Растеризация PNG миниатюр: вырожденная геометрия и ошибки OutOfMemory

## Проблема (обобщённо)

- Растеризатор `System.Drawing`/GDI+ может выбрасывать `OutOfMemory` при отрисовке вырожденной или чрезмерно мелкой геометрии (нулевые/субпиксельные размеры, `NaN`/`Infinity` в параметрах).
- В данном контексте `OutOfMemory` фактически означает «некорректные параметры» (внутренний `InvalidParameter`), а не реальную нехватку памяти.
- Ситуация не связана с настройками толщины линии в CAD: причина — параметры, которые передаются растеризатору.

## Почему возникает

- Миниатюры рендерятся с сильным масштабированием; округления дают субпиксельные размеры примитивов.
- Толщина штриха сопоставима или больше геометрии — внутренний стропинг GDI+ выходит за допустимые пределы.
- Ошибки в расчётах габаритов/трансформации: нулевой диапазон (деление на 0), накопление `NaN`/`Infinity`.

## Как обходить/защищаться

- Нормализовать трансформацию:
  - Если `rangeX`/`rangeY <= 0` — подставлять `1.0` до вычисления `scale`.
  - Проверять `scale`/`offsetX`/`offsetY` на конечность; неконечные значения заменять дефолтами.

- Предвалидация параметров примитивов перед рисованием:
  - Координаты/размеры/углы — только конечные числа.
  - Ширина/высота/радиус/длина должны быть больше порога `ε` (рекомендуемо `ε ≈ 0.05 px`).

- Деградация (fallback) для «слишком мелкой» или невалидной геометрии:
  - Заменять проблемный примитив на более простой (например, на отрезок между опорными точками) либо пропускать сегмент.
  - Оборачивать вызовы рисования в `try/catch` и при `OutOfMemory` выполнять безопасный фолбэк.

- Управление штрихом:
  - Вычислять толщину относительно viewport и клампить в разумный диапазон (например, 1.5%–3.75% от размера превью).
  - Опционально уменьшать штрих для локально «мелкой» геометрии.

## Диагностика (по необходимости)

- Под условной компиляцией (`#if DEBUG`) логировать:
  - Рассчитанные `bounds`, `scale`, `offset`.
  - Параметры примитивов до отрисовки (координаты, размеры) с проверкой на `NaN`/`Infinity` и сопоставлением с порогом `ε`.

## Итог

Класс ошибок обусловлен тем, что растеризатор получает вырожденные/некорректные параметры. Защита достигается предвалидацией трансформации и геометрии, клампами масштаба/штриха и безопасными фолбэками при рисовании. Это делает PNG‑рендер миниатюр детерминированным и устойчивым вне зависимости от настроек толщины линий в исходном чертеже.

